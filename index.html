<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheerfulGoat ä»»åŠ¡ç®¡ç† Â· ç»ˆæä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .delete-btn:hover { background-color: #dc2626 !important; color: white !important; }
    </style>
</head>
<body class="bg-orange-50/30 min-h-screen p-4 md:p-8 text-gray-800">
    <script>
        // 1. ç™»å½•ä¿å®‰
        const token = localStorage.getItem('cheerful_goat_token');
        if (!token) { window.location.href = 'login.html'; }
        console.log("CheerfulGoat ç³»ç»Ÿå·²åŠ è½½ - ç‰ˆæœ¬ 2026.01.08");
    </script>

    <div class="max-w-6xl mx-auto pb-20">
        <div class="flex flex-col items-center mb-10 text-center">
            <div class="bg-white p-4 rounded-full shadow-lg mb-4 border-2 border-orange-100">
                <img src="WechatIMG473.jpg" alt="Logo" class="h-16 w-auto">
            </div>
            <h1 class="text-3xl font-black text-gray-900 tracking-tight">CheerfulGoat</h1>
            <p class="text-orange-600 font-bold mt-1 text-xs tracking-widest uppercase">Task Master Center</p>
            <button onclick="logout()" class="mt-4 text-xs text-gray-400 hover:text-orange-600 underline">å®‰å…¨ç™»å‡ºç³»ç»Ÿ</button>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-3xl shadow-2xl border border-orange-100 sticky top-8">
                    <h2 class="text-xl font-bold mb-6 flex items-center text-orange-600">
                        <span class="bg-orange-500 text-white p-2 rounded-xl mr-3 text-lg">â•</span>æ–°å¢ä¸šåŠ¡ä»»åŠ¡
                    </h2>
                    <form id="taskForm" class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">ä»»åŠ¡åç§°</label>
                            <input type="text" id="title" required placeholder="å¦‚ï¼šè™¾çš®å¤§ä¿ƒæ´»åŠ¨" class="w-full border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none focus:ring-2 focus:ring-orange-500 transition-all">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">æ‰€å±å¹³å°</label>
                                <select id="platform" class="w-full border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none">
                                    <option>äºšé©¬é€Š</option><option>ç‹¬ç«‹ç«™</option><option>è™¾çš®</option>
                                    <option>TikTok</option><option>Bç«¯</option><option>æ‚é¡¹</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">æˆªæ­¢æ—¥æœŸ</label>
                                <input type="date" id="deadline" class="w-full border-gray-100 bg-gray-50 rounded-2xl p-4 outline-none text-xs">
                            </div>
                        </div>
                        <div class="flex items-center p-4 bg-red-50 rounded-2xl border border-red-100 mb-4">
                            <input type="checkbox" id="is_urgent" class="h-6 w-6 text-red-600 rounded-lg">
                            <label class="ml-3 text-sm text-red-700 font-black italic">æ ‡è®°ä¸ºç‰¹æ€¥ä»»åŠ¡ ğŸ”¥</label>
                        </div>
                        <button type="submit" class="w-full bg-orange-500 text-white font-black py-5 rounded-2xl hover:bg-orange-600 shadow-xl shadow-orange-200 transition-all text-lg tracking-widest">
                            æäº¤åˆ°äº‘ç«¯
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-4 rounded-3xl shadow-md border border-gray-100 flex flex-wrap gap-4 items-center">
                    <input type="text" id="searchInput" oninput="applyFilters()" placeholder="ğŸ” å¿«é€Ÿæœç´¢ä»»åŠ¡æ ‡é¢˜..." class="flex-1 min-w-[200px] bg-gray-100 border-none rounded-2xl px-6 py-3 outline-none focus:ring-2 focus:ring-orange-400">
                    <select id="filterPlatform" onchange="applyFilters()" class="bg-gray-100 border-none rounded-2xl px-6 py-3 text-sm font-bold outline-none">
                        <option value="å…¨éƒ¨å¹³å°">å…¨éƒ¨å¹³å°</option>
                        <option>äºšé©¬é€Š</option><option>ç‹¬ç«‹ç«™</option><option>è™¾çš®</option>
                        <option>TikTok</option><option>Bç«¯</option><option>æ‚é¡¹</option>
                    </select>
                </div>

                <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-8 py-6 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="font-black text-gray-800 text-lg flex items-center">
                            <span class="w-3 h-3 bg-orange-500 rounded-full mr-3 animate-pulse"></span>ä»»åŠ¡çœ‹æ¿
                        </h2>
                        <div id="taskCount" class="text-[10px] font-black text-orange-600 bg-white px-3 py-1.5 rounded-full shadow-sm border border-orange-100 tracking-tighter">åŒæ­¥ä¸­...</div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead class="bg-gray-50/80 text-left border-b border-gray-100">
                                <tr>
                                    <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">çŠ¶æ€</th>
                                    <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest">ä»»åŠ¡æ˜ç»†</th>
                                    <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">æ“ä½œç®¡ç†</th>
                                </tr>
                            </thead>
                            <tbody id="taskList" class="divide-y divide-gray-50">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-20 text-center">
            <p class="text-[10px] text-gray-300 font-bold uppercase tracking-[0.3em]">Version: 2026.01.08.FINAL_FIX Â· å¢åˆ å¢å¼ºç‰ˆ</p>
        </div>
    </div>

    <script>
        const API_BASE = "https://cheerfulgoat-task-system.onrender.com";
        let allTasks = [];

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('cheerful_goat_token');
            options.headers = { ...options.headers, 'Authorization': `Bearer ${token}` };
            const response = await fetch(url, options);
            if (response.status === 401) { logout(); return; }
            return response;
        }

        document.getElementById('taskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('title').value,
                platform: document.getElementById('platform').value,
                is_urgent: document.getElementById('is_urgent').checked,
                deadline: document.getElementById('deadline').value || null
            };
            const res = await fetchWithAuth(`${API_BASE}/tasks/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (res && res.ok) { document.getElementById('taskForm').reset(); fetchTasks(); }
        });

        async function fetchTasks() {
            const res = await fetchWithAuth(`${API_BASE}/tasks/`);
            if (res && res.ok) {
                allTasks = await res.json();
                document.getElementById('taskCount').textContent = `å½“å‰å…±æœ‰ ${allTasks.length} é¡¹ä»»åŠ¡`;
                applyFilters();
            }
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const platform = document.getElementById('filterPlatform').value;
            const filtered = allTasks.filter(t => t.title.toLowerCase().includes(search) && (platform === 'å…¨éƒ¨å¹³å°' || t.platform === platform));
            renderTaskList(filtered);
        }

        function renderTaskList(tasks) {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            tasks.sort((a, b) => b.is_urgent - a.is_urgent);

            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = "hover:bg-orange-50/10 transition-colors group";
                
                let deadlineHtml = 'é•¿æœŸä»»åŠ¡';
                let deadlineClass = 'text-gray-400';
                if (task.deadline) {
                    const diffHours = (new Date(task.deadline) - new Date()) / 3600000;
                    if (diffHours < 0) { deadlineHtml = `ğŸš« å·²é€¾æœŸ`; deadlineClass = 'text-red-600 font-black'; }
                    else if (diffHours < 24) { deadlineHtml = `ğŸ”¥ æ˜å¤©åˆ°æœŸ`; deadlineClass = 'text-red-500 font-black animate-pulse'; }
                    else { deadlineHtml = `ğŸ“… ${new Date(task.deadline).toLocaleDateString()}`; }
                }

                const statusBg = task.status === 'å·²å®Œæˆ' ? 'bg-gray-100 text-gray-500' : (task.is_urgent ? 'bg-red-600 text-white' : 'bg-orange-500 text-white');

                row.innerHTML = `
                    <td class="px-8 py-8">
                        <span class="px-3 py-1.5 text-[9px] font-black rounded-lg ${statusBg}">
                            ${task.status}
                        </span>
                    </td>
                    <td class="px-8 py-8">
                        <div class="flex items-center gap-2 mb-2 text-sm font-bold text-gray-900 leading-tight">
                            <span class="text-[8px] bg-black text-white px-1.5 py-0.5 rounded uppercase tracking-tighter">${task.platform}</span>
                            ${task.title}
                        </div>
                        <div class="text-[10px] ${deadlineClass} flex items-center px-2 py-0.5 bg-gray-50 w-fit rounded border border-gray-100">
                            ${deadlineHtml}
                        </div>
                    </td>
                    <td class="px-8 py-8 text-center">
                        <div class="flex flex-col gap-2 max-w-[120px] mx-auto">
                            <select onchange="updateStatus(${task.id}, this.value)" class="text-[10px] font-bold border-gray-200 rounded-xl p-2 outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="å¾…å¤„ç†" ${task.status === 'å¾…å¤„ç†' ? 'selected' : ''}>å¾…å¤„ç†</option>
                                <option value="è¿›è¡Œä¸­" ${task.status === 'è¿›è¡Œä¸­' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                                <option value="å·²å®Œæˆ" ${task.status === 'å·²å®Œæˆ' ? 'selected' : ''}>å·²å®Œæˆ</option>
                            </select>
                            <button onclick="confirmDelete(${task.id})" class="delete-btn w-full py-2 rounded-xl bg-red-50 border border-red-200 text-red-600 text-[10px] font-black transition-all">
                                ğŸ—‘ï¸ å½»åº•åˆ é™¤
                            </button>
                        </div>
                    </td>
                `;
                list.appendChild(row);
            });
        }

        async function updateStatus(id, newStatus) {
            await fetchWithAuth(`${API_BASE}/tasks/${id}/status?new_status=${encodeURIComponent(newStatus)}`, { method: 'PUT' });
            fetchTasks();
        }

        async function confirmDelete(id) {
            if (confirm("âš ï¸ çˆ·çˆ·è¯·ç¡®è®¤ï¼šæ‚¨çœŸçš„è¦æ°¸ä¹…åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ")) {
                const res = await fetchWithAuth(`${API_BASE}/tasks/${id}`, { method: 'DELETE' });
                if (res && res.ok) fetchTasks();
            }
        }

        function logout() { localStorage.removeItem('cheerful_goat_token'); window.location.href = 'login.html'; }
        fetchTasks();
    </script>
</body>
</html>
